<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Helpers for testing I/O behavior with partial, interrupted and blocking reads and writes."><meta name="keywords" content="rust, rustlang, rust-lang, partial_io"><title>partial_io - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../dark.css" disabled><link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../storage.js"></script><script defer src="../crates.js"></script><script defer src="../main.js"></script><noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../favicon.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../partial_io/index.html"><div class="logo-container"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../partial_io/index.html"><div class="logo-container"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></div></a><h2 class="location"><a href="#">Crate partial_io</a></h2><div class="sidebar-elems"><div class="block"><ul><li class="version">Version 0.5.2</li><li><a id="all-types" href="all.html">All Items</a></li></ul></div><section><div class="block"><ul><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#traits">Traits</a></li></ul></div></section></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../partial_io/index.html"><img class="rust-logo" src="../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn"><span class="in-band">Crate <a class="mod" href="#">partial_io</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../src/partial_io/lib.rs.html#4-149">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Helpers for testing I/O behavior with partial, interrupted and blocking reads and writes.</p>
<p>This library provides:</p>
<ul>
<li><code>PartialRead</code> and <code>PartialWrite</code>, which wrap existing <code>Read</code> and
<code>Write</code> implementations and allow specifying arbitrary behavior on the
next <code>read</code>, <code>write</code> or <code>flush</code> call.</li>
<li>With the optional <code>futures03</code> and <code>tokio1</code> features, <code>PartialAsyncRead</code> and
<code>PartialAsyncWrite</code> to wrap existing <code>AsyncRead</code> and <code>AsyncWrite</code>
implementations. These implementations are task-aware, so they will know
how to pause and unpause tasks if they return a <code>WouldBlock</code> error.</li>
<li>With the optional <code>quickcheck1</code> feature, generation of random sequences of
operations which can be provided to one of the wrappers. See the
<code>quickcheck_types</code> documentation for more.</li>
</ul>
<h2 id="motivation"><a href="#motivation">Motivation</a></h2>
<p>A <code>Read</code> or <code>Write</code> wrapper is conceptually simple but can be difficult to
get right, especially if the wrapper has an internal buffer. Common
issues include:</p>
<ul>
<li>A partial read or write, even without an error, might leave the wrapper
in an invalid state (<a href="https://github.com/gyscos/zstd-rs/commit/3123e418595f6badd5b06db2a14c4ff4555e7705">example fix</a>).</li>
</ul>
<p>With the <code>AsyncRead</code> and <code>AsyncWrite</code> provided by <code>futures03</code> and <code>tokio1</code>:</p>
<ul>
<li>A call to <code>read_to_end</code> or <code>write_all</code> within the wrapper might be partly
successful but then error out. These functions will return the error
without informing the caller of how much was read or written. Wrappers
with an internal buffer will want to advance their state corresponding
to the partial success, so they can’t use <code>read_to_end</code> or <code>write_all</code>
(<a href="https://github.com/gyscos/zstd-rs/commit/02dc9d9a3419618fc729542b45c96c32b0f178bb">example fix</a>).</li>
<li>Instances must propagate <code>Poll::Pending</code> up, but that shouldn’t leave
them in an invalid state.</li>
</ul>
<p>These situations can be hard to think about and hard to test.</p>
<p><code>partial-io</code> can help in two ways:</p>
<ol>
<li>For a known bug involving any of these situations, <code>partial-io</code> can help
you write a test.</li>
<li>With the <code>quickcheck1</code> feature enabled, <code>partial-io</code> can also help shake
out bugs in your wrapper. See <code>quickcheck_types</code> for more.</li>
</ol>
<h2 id="examples"><a href="#examples">Examples</a></h2>
<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">std::io</span>::{<span class="self">self</span>, <span class="ident">Cursor</span>, <span class="ident">Read</span>};

<span class="kw">use</span> <span class="ident">partial_io</span>::{<span class="ident">PartialOp</span>, <span class="ident">PartialRead</span>};

<span class="kw">let</span> <span class="ident">data</span> <span class="op">=</span> <span class="string">b&quot;Hello, world!&quot;</span>.<span class="ident">to_vec</span>();
<span class="kw">let</span> <span class="ident">cursor</span> <span class="op">=</span> <span class="ident">Cursor::new</span>(<span class="ident">data</span>);  <span class="comment">// Cursor&lt;Vec&lt;u8&gt;&gt; implements io::Read</span>
<span class="kw">let</span> <span class="ident">ops</span> <span class="op">=</span> <span class="macro">vec!</span>[<span class="ident">PartialOp::Limited</span>(<span class="number">7</span>), <span class="ident">PartialOp::Err</span>(<span class="ident">io::ErrorKind::Interrupted</span>)];
<span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">partial_read</span> <span class="op">=</span> <span class="ident">PartialRead::new</span>(<span class="ident">cursor</span>, <span class="ident">ops</span>);

<span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">out</span> <span class="op">=</span> <span class="macro">vec!</span>[<span class="number">0</span>; <span class="number">256</span>];

<span class="comment">// The first read will read 7 bytes.</span>
<span class="macro">assert_eq!</span>(<span class="ident">partial_read</span>.<span class="ident">read</span>(<span class="kw-2">&amp;mut</span> <span class="ident">out</span>).<span class="ident">unwrap</span>(), <span class="number">7</span>);
<span class="macro">assert_eq!</span>(<span class="kw-2">&amp;</span><span class="ident">out</span>[..<span class="number">7</span>], <span class="string">b&quot;Hello, &quot;</span>);
<span class="comment">// The second read will fail with ErrorKind::Interrupted.</span>
<span class="macro">assert_eq!</span>(<span class="ident">partial_read</span>.<span class="ident">read</span>(<span class="kw-2">&amp;mut</span> <span class="ident">out</span>[<span class="number">7</span>..]).<span class="ident">unwrap_err</span>().<span class="ident">kind</span>(), <span class="ident">io::ErrorKind::Interrupted</span>);
<span class="comment">// The iterator has run out of operations, so it no longer truncates reads.</span>
<span class="macro">assert_eq!</span>(<span class="ident">partial_read</span>.<span class="ident">read</span>(<span class="kw-2">&amp;mut</span> <span class="ident">out</span>[<span class="number">7</span>..]).<span class="ident">unwrap</span>(), <span class="number">6</span>);
<span class="macro">assert_eq!</span>(<span class="kw-2">&amp;</span><span class="ident">out</span>[..<span class="number">13</span>], <span class="string">b&quot;Hello, world!&quot;</span>);</code></pre></div>
<p>For a real-world example, see the <a href="https://github.com/gyscos/zstd-rs/blob/master/src/stream/mod.rs">tests in <code>zstd-rs</code></a>.</p>
</div></details><h2 id="modules" class="small-section-header"><a href="#modules">Modules</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="mod" href="proptest_types/index.html" title="partial_io::proptest_types mod">proptest_types</a><span class="stab portability" title="Available on crate feature `proptest1` only"><code>proptest1</code></span></div><div class="item-right docblock-short"><p>Proptest support for partial IO operations.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="mod" href="quickcheck_types/index.html" title="partial_io::quickcheck_types mod">quickcheck_types</a><span class="stab portability" title="Available on crate feature `quickcheck1` only"><code>quickcheck1</code></span></div><div class="item-right docblock-short"><p><code>QuickCheck</code> support for partial IO operations.</p>
</div></div></div><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.PartialAsyncRead.html" title="partial_io::PartialAsyncRead struct">PartialAsyncRead</a></div><div class="item-right docblock-short"><p>A wrapper that breaks inner <code>AsyncRead</code> instances up according to the
provided iterator.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.PartialAsyncWrite.html" title="partial_io::PartialAsyncWrite struct">PartialAsyncWrite</a></div><div class="item-right docblock-short"><p>A wrapper that breaks inner <code>AsyncWrite</code> instances up according to the
provided iterator.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.PartialRead.html" title="partial_io::PartialRead struct">PartialRead</a></div><div class="item-right docblock-short"><p>A reader wrapper that breaks inner <code>Read</code> instances up according to the
provided iterator.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.PartialWrite.html" title="partial_io::PartialWrite struct">PartialWrite</a></div><div class="item-right docblock-short"><p>A writer wrapper that breaks inner <code>Write</code> instances up according to the
provided iterator.</p>
</div></div></div><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.PartialOp.html" title="partial_io::PartialOp enum">PartialOp</a></div><div class="item-right docblock-short"><p>What to do the next time an IO operation is performed.</p>
</div></div></div><h2 id="traits" class="small-section-header"><a href="#traits">Traits</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="trait" href="trait.ReadBufExt.html" title="partial_io::ReadBufExt trait">ReadBufExt</a></div><div class="item-right docblock-short"><p>Extensions to <code>tokio</code>’s <code>ReadBuf</code>.</p>
</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../" data-current-crate="partial_io" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.64.0 (a55dd71d5 2022-09-19)" ></div></body></html>